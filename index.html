<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>!-->
    <title>Test</title>
</head>
<body>
  <h1 id="ws-status">websocket...</h1>
    <img id="image" src="/room.png" alt="">
    <div id="liveView" class="videoView">
      <button id="webcamButton" class="mdc-button mdc-button--raised">
        <span class="mdc-button__ripple"></span>
        <span class="mdc-button__label">ENABLE WEBCAM</span>
      </button>
      <video id="webcam" autoplay playsinline></video>
    </div>
    <h1 id="detection"></h1>
</body>
<!--<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.mjs" crossorigin="anonymous" type="module"></script>!-->

<script type="module">
const ws = new WebSocket("wss://toma-ru.onrender.com");
ws.addEventListener("open", (event) => {
  console.log("connected to server by websocket");
  document.querySelector("#ws-status").innerHTML = "websocket connected!";
});
ws.addEventListener("message", (event) => {
  console.log("fron server: ", event.data);
});

let runningMode = "IMAGE";
import {
  ObjectDetector,
  FilesetResolver,
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2"
const vision = await FilesetResolver.forVisionTasks(
  // path/to/wasm/root
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
);
const objectDetector = await ObjectDetector.createFromOptions(vision, {
  baseOptions: {
    modelAssetPath: `https://storage.googleapis.com/mediapipe-tasks/object_detector/efficientdet_lite0_uint8.tflite`
  },
  scoreThreshold: 0.5,
  runningMode: runningMode
});
const enableWebcamButton = document.getElementById("webcamButton");
enableWebcamButton.addEventListener("click", enableCam);
const image = document.getElementById("image");
const detections = objectDetector.detect(image)["detections"];
detections.forEach(detection => {
  console.log(detection.categories[0].score);
  console.log(detection.categories[0].categoryName);
});

function hasGetUserMedia() {
  return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
}

let video = document.getElementById("webcam");
const liveView = document.getElementById("liveView");
async function enableCam(event) {
  if (!objectDetector) {
    console.log("Wait! objectDetector not loaded yet.");
    return;
  }

  // getUsermedia parameters
  const constraints = {
    video: true
  };

  // Activate the webcam stream.
  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(function (stream) {
      video.srcObject = stream;
      video.addEventListener("loadeddata", predictWebcam);
    })
    .catch((err) => {
      console.error(err);
      /* handle the error */
    });
}

let lastVideoTime = -1;
async function predictWebcam() {
  // if image mode is initialized, create a new classifier with video runningMode.
  if (runningMode === "IMAGE") {
    runningMode = "VIDEO";
    await objectDetector.setOptions({ runningMode: "VIDEO" });
  }
  let startTimeMs = performance.now();

  // Detect objects using detectForVideo.
  if (video.currentTime !== lastVideoTime) {
    lastVideoTime = video.currentTime;
    const detections = objectDetector.detectForVideo(video, startTimeMs);
    displayVideoDetections(detections);
  }
  // Call this function again to keep predicting when the browser is ready.
  window.requestAnimationFrame(predictWebcam);
}

async function displayVideoDetections(detections){
  let strToShow = "";
  let containsCar = false;
  for(let detection of detections.detections){
    if(detection.categories[0].categoryName == "car"){
      containsCar = true;
    }
    strToShow += `${detection.categories[0].categoryName} ${Math.round(parseFloat(detection.categories[0].score) * 100)}<br>`;
  }
  document.querySelector("#detection").innerHTML = strToShow;
  if(containsCar){
    //fetch("/brake", {method: "POST"});
    //fetch("/disconnect", {method: "POST"});
    ws.send("brake");
    ws.send("disconnect");
  }
}

</script>
</html>